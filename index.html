<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Free PDF Merger</title>
    <link rel="stylesheet" href="stylesheet.css">
</head>

<body>
    <div class="container">
    <h2>Free PDF Merger</h2>
    <div id="drop-area">
        <p>Drag & drop PDF files here, or click to select files</p>
        <input type="file" id="fileElem" multiple accept="application/pdf" style="display:none">
        <button onclick="document.getElementById('fileElem').click()">Select PDFs</button>
    </div>
    <a id="download-link" href="#" download="combined_files.pdf">Download Merged PDF</a>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script>
        const dropArea = document.getElementById('drop-area');
        const fileElem = document.getElementById('fileElem');
        const downloadLink = document.getElementById('download-link');

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        fileElem.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files } });
        }

        async function handleFiles(e) {
            const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
            if (files.length < 2) {
                alert('Please select at least two PDF files.');
                return;
            }

            // Wait for pdf-lib to be loaded
            await waitForPdfLib();

            try {
                const mergedPdf = await mergePDFs(files);
                const blob = new Blob([mergedPdf], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.style.display = 'inline-block';
            } catch (err) {
                alert('Error merging PDFs: ' + err.message);
            }
        }

        function waitForPdfLib() {
            return new Promise((resolve, reject) => {
                if (window.PDFLib && window.PDFLib.PDFDocument) {
                    resolve();
                } else {
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds max wait
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.PDFLib && window.PDFLib.PDFDocument) {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error('PDF-lib library failed to load. Please refresh the page.'));
                        }
                    }, 100);
                }
            });
        }

        async function mergePDFs(files) {
            if (!window.PDFLib || !window.PDFLib.PDFDocument) {
                throw new Error('PDF-lib library not loaded. Please refresh the page and try again.');
            }
            const { PDFDocument } = window.PDFLib;
            const mergedPdf = await PDFDocument.create();

            for (const file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await PDFDocument.load(arrayBuffer);
                const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                copiedPages.forEach(page => mergedPdf.addPage(page));
            }

            return await mergedPdf.save();
        }
    </script>
    <footer>
        <p style="color: gray;">
            Made by <a href="https://github.com/phyulwin" target="_blank" style="color: gray; text-decoration: underline;">Phyu Hnin Lwin</a>
        </p></p>
    </footer>
    </div>
</body>

</html>